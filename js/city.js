
// 定义城市数据
var cities = [
    {
        "type": "FeatureCollection",
        "generator": "overpass-turbo",
        "copyright": "The data included in this document is from www.openstreetmap.org. The data is made available under ODbL.",
        "timestamp": "2024-07-30T04:51:14Z",
        "features": [
          {
            "type": "Feature",
            "properties": {
              "@id": "node/21640149",
              "capital": "4",
              "name": "Pori",
              "place": "city",
              "population": "83 117",
              "population:date": "2023-12-31",
              "source:population": "Tilastokeskus",
              "start_date": "before 1724",
              "url": "https://www.pori.fi/",
              "wikidata": "Q180233",
              "wikipedia": "fi:Pori"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                21.7972071,
                61.4866126
              ]
            },
            "id": "node/21640149"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/21847490",
              "capital": "4",
              "name": "Turku",
              "name:ar": "توركو",
              "place": "city",
              "population": "201889",
              "population:date": "2023-12-31",
              "postal_code": "20100",
              "source:name": "common knowledge",
              "source:population": "Tilastokeskus",
              "url": "https://www.turku.fi/",
              "wikidata": "Q38511",
              "wikipedia": "fi:Turku"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                22.2670522,
                60.4517531
              ]
            },
            "id": "node/21847490"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/22980865",
              "name": "Porvoo",
              
              "place": "city",
              "population": "51 293",
              "population:date": "2023-12-31",
              "ref:LOCODE": "FIPRV",
              "source:name": "common knowledge",
              "source:population": "Tilastokeskus",
              "url": "http://www.porvoo.fi/",
              "wikidata": "Q193367",
              "wikipedia": "fi:Porvoo"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                25.6604862,
                60.3953913
              ]
            },
            "id": "node/22980865"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/25963545",
              "name": "Espoo",
              
              "place": "city",
              "population": "314152",
              "population:date": "2023-12-31",
              "source:population": "Tilastokeskus",
              "wikidata": "Q47034",
              "wikipedia": "fi:Espoo"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                24.6568435,
                60.2047672
              ]
            },
            "id": "node/25963545"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/29064107",
              "name": "Oulu",
              
              "place": "city",
              "population": "214651",
              "population:date": "2023-12-31",
              "source:population": "Tilastokeskus",
              "website": "https://www.ouka.fi/",
              "wikidata": "Q47048",
              "wikipedia": "fi:Oulu"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                25.4716809,
                65.0118734
              ]
            },
            "id": "node/29064107"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30871749",
              "name": "Vantaa",
              
              "place": "city",
              "population": "247447",
              "population:date": "2023-12-31",
              "source:population": "Tilastokeskus",
              "url": "http://www.vantaa.fi/",
              "wikidata": "Q127623",
              "wikipedia": "fi:Vantaa"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                25.0407809,
                60.2933337
              ]
            },
            "id": "node/30871749"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969480",
              "capital": "4",
              "gns:ufi": "-1388513",
              "name": "Tampere",
              
              "place": "city",
              "population": "255066",
              "population:date": "2023-12-31",
              "source": "gns",
              "start_date": "1779",
              "website": "https://www.tampere.fi/",
              "wikidata": "Q40840",
              "wikipedia": "fi:Tampere"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                23.7603118,
                61.4980214
              ]
            },
            "id": "node/30969480"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969492",
              "alt_name": "Keskusta",
              "gns:ufi": "-1373077",
              "name": "Kuopio",
              
              "place": "city",
              "population": "124011",
              "population:date": "2023-12-31",
              "source": "gns",
              "source:population": "Tilastokeskus",
              "website": "https://www.kuopio.fi/",
              "wikidata": "Q162279",
              "wikipedia": "fi:Kuopio"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                27.6781839,
                62.8924601
              ]
            },
            "id": "node/30969492"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969494",
              "gns:ufi": "-1373945",
              "name": "Lahti",
              
              "place": "city",
              "population": "120700",
              "population:date": "2023-12-31",
              "source": "gnssss Landsat",
              "source:population": "Tilastokeskus",
              "url": "https://www.lahti.fi/",
              "wikidata": "Q28911",
              "wikipedia": "fi:Lahti"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                25.6613764,
                60.9826014
              ]
            },
            "id": "node/30969494"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969521",
              "gns:ufi": "-1367432",
              "name": "Joensuu",
             
              "place": "city",
              "population": "78 060",
              "population:date": "2023-12-31",
              "short_name": "JNS",
              "source": "gns",
              "source:population": "Tilastokeskus",
              "url": "http://www.jns.fi/",
              "wikidata": "Q186237",
              "wikipedia": "fi:Joensuu"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                29.7622128,
                62.6005753
              ]
            },
            "id": "node/30969521"
          },
         
          
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969529",
              "gns:ufi": "-1372348",
              "name": "Kotka",
             
              "place": "city",
              "population": "50 488",
              "population:date": "2023-12-31",
              "ref:LOCODE": "FIKTK",
              "source": "gns",
              "source:population": "Tilastokeskus",
              "url": "https://www.kotka.fi/",
              "wikidata": "Q192155",
              "wikipedia": "fi:Kotka (kaupunki)"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                26.9450844,
                60.4674228
              ]
            },
            "id": "node/30969529"
          },
          
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969531",
              "gns:ufi": "-1374408",
              "name": "Lappeenranta",
              
              "place": "city",
              "population": "73 016",
              "population:date": "2023-12-31",
              "source": "gns",
              "source:population": "Tilastokeskus",
              "url": "http://www.lappeenranta.fi/",
              "wikidata": "Q181854",
              "wikipedia": "fi:Lappeenranta"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                28.1862742,
                61.0583713
              ]
            },
            "id": "node/30969531"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969534",
              "gns:ufi": "-1383675",
              "name": "Rauma",
             
              "place": "city",
              "population": "38 837",
              "population:date": "2023-12-31",
              "ref:LOCODE": "FIRAU",
              "source": "gns",
              "source:population": "Tilastokeskus",
              "start_date": "before 1724",
              "url": "http://www.rauma.fi/",
              "wikidata": "Q37013",
              "wikipedia": "fi:Rauma"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                21.5039401,
                61.1289148
              ]
            },
            "id": "node/30969534"
          },
         
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969538",
              "capital": "4",
              "gns:ufi": "-1364028",
              "name": "Hameenlinna",
              "place": "city",
              "population": "68 303",
              "population:date": "2023-12-31",
              "source": "gns",
              "url": "http://www.hameenlinna.fi/",
              "wikidata": "Q202158",
              "wikipedia": "fi:Hämeenlinna"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                24.46654,
                60.9948584
              ]
            },
            "id": "node/30969538"
          },
          
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969707",
              "gns:ufi": "-1375561",
              "name": "Lohja",
              
              "place": "city",
              "population": "45 654",
              "population:date": "2023-12-31",
              "source": "gns,Landsat",
              "source:population": "Tilastokeskus",
              "wikidata": "Q214777",
              "wikipedia": "fi:Lohja"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                24.0684575,
                60.2526036
              ]
            },
            "id": "node/30969707"
          },
         
          {
            "type": "Feature",
            "properties": {
              "@id": "node/30969854",
              "alt_name:sv": "Sankt Michel",
              "gns:ufi": "-1377328",
              "name": "Mikkeli",
              
              "place": "city",
              "population": "51 916",
              "population:date": "2023-12-31",
              "source": "gns",
              "source:population": "Tilastokeskus",
              "wikidata": "Q190583",
              "wikipedia": "fi:Mikkeli"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                27.2726569,
                61.6877956
              ]
            },
            "id": "node/30969854"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/82989938",
              "capital": "6",
              "name": "Jyvaskyla",
             
              "place": "city",
              "population": "147821",
              "population:date": "2023-12-31",
              "source:population": "Tilastokeskus",
              "website": "https://www.jyvaskyla.fi/",
              "wikidata": "Q134620",
              "wikipedia": "en:Jyväskylä"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                25.7495727,
                62.2417066
              ]
            },
            "id": "node/82989938"
          },
         
          {
            "type": "Feature",
            "properties": {
              "@id": "node/1372477580",
              "admin_level": "2",
              "alt_name:gl": "Helsinki",
              "alt_name:grc": "Ἑλσιγκία",
              "capital": "yes",
              "capital_ISO3166-1": "yes",
              "gns:ufi": "-1364995",
              "loc_name": "Stadi;Hesa",
              "name": "Helsinki",
              "note": "This spot is used to calculate distance from Helsinki for road signs, aka 0 km Helsinki",
              "place": "city",
              "population": "674963",
              "population:date": "2023-12-31",
              "ref:LOCODE": "FIHEL",
              "source": "gns",
              "source:name:br": "ofis publik ar brezhoneg",
              "source:name:oc": "Lo Congrès",
              "source:population": "Tilastokeskus",
              "url": "http://www.hel.fi",
              "wikidata": "Q1757",
              "wikimedia_commons": "Category:Helsinki",
              "wikipedia": "fi:Helsinki"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                24.9427473,
                60.1674881
              ]
            },
            "id": "node/1372477580"
          },
          {
            "type": "Feature",
            "properties": {
              "@id": "node/1637607582",
              "capital": "4",
              "gns:ufi": "-1390532",
              "name": "Vaasa",
              "place": "city",
              "population": "68 969",
              "population:date": "2023-12-31",
              "postal_code": "65100",
              "source": "gns",
              "source:population": "Tilastokeskus",
              "url": "www.vaasa.fi",
              "wikidata": "Q125080",
              "wikipedia": "fi:Vaasa"
            },
            "geometry": {
              "type": "Point",
              "coordinates": [
                21.6159187,
                63.0957722
              ]
            },
            "id": "node/1637607582"
          }
        ]
      }
];

console.log(datalist_au_0818); // 调试输出处理后的数据

var currentLines = [];

// 清除当前线段的函数
function clearLines() {
  currentLines.forEach(function(line) {
    map.removeLayer(line.line);
    clearInterval(line.interval);
  });
  currentLines = [];
}

// 创建动态线段的函数
function createDynamicLine(startLatLng, endLatLng, from, to, times) {
  var weight = Math.min(Math.max(times / 10, 1), 5); // 确保线段粗细在 1 到 5 之间
  var polyline = L.polyline([startLatLng, endLatLng], {
    color: 'blue',
    weight: weight,
    opacity: 0.7,
    dashArray: '10, 10',
    lineJoin: 'round'
  }).addTo(map);

  // 动态虚线效果
  var dashOffset = 0;
  var interval = setInterval(function() {
    dashOffset = (dashOffset + 1) % 20;
    polyline.setStyle({
      dashOffset: dashOffset
    });
  }, 100);

  // 添加弹出框
  polyline.bindPopup(`<b>从:</b> ${from}<br><b>到:</b> ${to}<br><b>次数:</b> ${times}`);

  // 鼠标悬停事件
  polyline.on('mouseover', function(e) {
    this.openPopup();
  });
  polyline.on('mouseout', function(e) {
    this.closePopup();
  });

  currentLines.push({
    line: polyline,
    interval: interval
  });

  return polyline;
}

// 默认和红色图标定义
var defaultIcon = L.icon({
  iconUrl: 'img/blue.png', // 替换为你的默认图标路径
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

var redIcon = L.icon({
  iconUrl: 'img/red.png', // 替换为你的红色图标路径
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

// 为城市创建 GeoJSON 图层
L.geoJSON(cities, {
  pointToLayer: function (feature, latlng) {
    return L.marker(latlng, { icon: defaultIcon });
  },
  onEachFeature: function (feature, layer) {
    var popupContent = "<b>城市:</b> " + feature.properties.name +
                       "<br><b>人口:</b> " + feature.properties.population;

    layer.bindPopup(popupContent);

    layer.on('click', function (e) {
      clearLines(); // 清除之前的线段

      if (selectedMarker) {
        selectedMarker.setIcon(defaultIcon); // 重置之前选中标记的颜色
      }
      selectedMarker = e.target; // 更新选中的标记
      selectedMarker.setIcon(redIcon); // 将选中标记变为红色

      var targetCity = feature.properties.name;
      var targetLatLng = e.latlng;

      console.log("点击的城市: " + targetCity); // 调试输出点击的城市

      datalist_au_0818.forEach(function(line) {
        if (line.from === targetCity) {
          console.log(`找到从 ${line.from} 到 ${line.to} 的线段`); // 调试输出匹配的线段

          var matchingCity = cities[0].features.find(function(city) {
            return city.properties.name === line.to;
          });

          if (matchingCity) {
            var startLatLng = [matchingCity.geometry.coordinates[1], matchingCity.geometry.coordinates[0]];
            var endLatLng = [targetLatLng.lat, targetLatLng.lng];
            console.log(`创建从 ${line.from} 到 ${line.to} 的线段`); // 调试输出线段信息
            createDynamicLine(startLatLng, endLatLng, line.from, line.to, line.time);
          } else {
            console.log(`未找到匹配的城市 ${line.to}`);
          }
        }
      });
    });

    layer.on('mouseover', function (e) {
      layer.setIcon(redIcon); // 鼠标悬停时改变图标为红色
      this.openPopup();
    });
    layer.on('mouseout', function (e) {
      if (layer !== selectedMarker) {
        layer.setIcon(defaultIcon); // 鼠标移出时恢复默认图标
      }
      this.closePopup();
    });
  }
}).addTo(map);

// 创建绘制图层组
var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

// 绘制控件
var drawControl = new L.Control.Draw({
  draw: {
    polygon: true,
    rectangle: true,
    circle: true,
    circlemarker: true,
    marker: true,
    polyline: true
  },
  edit: {
    featureGroup: drawnItems
  }
});
map.addControl(drawControl);

// 绘制创建事件监听器
map.on(L.Draw.Event.CREATED, function (event) {
  var layer = event.layer;
  drawnItems.addLayer(layer);
});

var selectedMarker = null; // 记录当前选中的标记

// 应用默认图标到所有标记
var geojson = L.geoJSON(geojsonFeature, {
  pointToLayer: function (feature, latlng) {
    return L.marker(latlng, { icon: defaultIcon });
  },
  onEachFeature: function (feature, layer) {
    layer.on('mouseover', function(e) {
      layer.setIcon(redIcon);
    });
    layer.on('mouseout', function(e) {
      if (layer !== selectedMarker) {
        layer.setIcon(defaultIcon);
      }
    });
  }
}).addTo(map);
